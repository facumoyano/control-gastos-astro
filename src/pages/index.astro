---
import Layout from '../layouts/Layout.astro';
import LayoutTracker from '../layouts/LayoutTracker.astro';
import LayoutPages from '../layouts/LayoutPages.astro';
import LineChart from '../components/charts/LineChart';
import PieChart from '../components/charts/PieChart';
import RecentHistory from '../components/dashboard/RecentHistory.astro';
import { app } from '../config/firebase-server';
import { getAuth } from 'firebase-admin/auth';
import { getFirestore } from "firebase-admin/firestore";
import TotalAmount from '../components/dashboard/TotalAmount.astro';


interface Transaction {
    id: string;
    title: string;
    amount: number;
    date: string;
    category: string;
    type: string;
	createdAt?: string | undefined;
}


const auth = getAuth(app);

/* Verificar la sesiÃ³n actual */
if (!Astro.cookies.has("session")) {
  return Astro.redirect("/signin");
}
const sessionCookie = Astro?.cookies?.get("session")?.value;
if(!sessionCookie) return null
const decodedCookie = await auth.verifySessionCookie(sessionCookie);
const user = await auth.getUser(decodedCookie.uid);

if (!user) {
  return Astro.redirect("/signin");
}

const db = getFirestore(app);
const incomesRef = db.collection("incomes");
const expensesRef = db.collection("expenses");

const incomesSnapshot = await incomesRef.get();
const expensesSnapshot = await expensesRef.get();

const incomes = incomesSnapshot.docs.map((doc) => ({
  id: doc.id,
  type: 'income',
  ...doc.data(),
})) as Transaction[];

const expenses = expensesSnapshot.docs.map((doc) => ({
  id: doc.id,
  type: 'expense',
  ...doc.data(),
})) as Transaction[];

const transactions = [...incomes, ...expenses]
  .sort((a, b) => new Date(b?.createdAt || 0).getTime() - new Date(a?.createdAt || 0).getTime())
  .slice(0, 5);

const totalIncomes = incomes.reduce((total, income) => total + income.amount, 0);
const totalExpenses = expenses.reduce((total, expense) => total + expense.amount, 0);
const totalBalance = totalIncomes - totalExpenses;  

---

<Layout title="Welcome to Astro.">
	<isAuthenticated>
		<LayoutPages>
			<LayoutTracker>
				<div class="grid grid-cols-12 gap-16 h-full">
					<div class="w-full col-span-6">
						<LineChart client:load />
					</div>
					<div class="w-full flex justify-center col-span-6">
						<PieChart client:load />
					</div>
					<div class="col-span-4">
						<RecentHistory transactions={transactions} />
					</div>
					<div class="flex gap-3 h-min col-span-8">
						<TotalAmount text="Total ingresos" amount={totalIncomes} />
						<TotalAmount text="Total egresos" amount={totalExpenses} />
						<TotalAmount text="Total Balance" amount={totalBalance} customClass={totalBalance >= 0 ? 'text-green-500' : 'text-red-500'} />
					</div>
				</div>
			</LayoutTracker>
		</LayoutPages>
	</isAuthenticated>
</Layout>
